var te=Object.defineProperty,ie=Object.defineProperties;var se=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var G=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable;var A=(r,e,t)=>e in r?te(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,w=(r,e)=>{for(var t in e||(e={}))G.call(e,t)&&A(r,t,e[t]);if(R)for(var t of R(e))X.call(e,t)&&A(r,t,e[t]);return r},$=(r,e)=>ie(r,se(e));var Y=(r,e)=>{var t={};for(var i in r)G.call(r,i)&&e.indexOf(i)<0&&(t[i]=r[i]);if(r!=null&&R)for(var i of R(r))e.indexOf(i)<0&&X.call(r,i)&&(t[i]=r[i]);return t};var g=(r,e,t)=>(A(r,typeof e!="symbol"?e+"":e,t),t);class V extends TypeError{constructor(){super("flow-view was provided with no valid element nor container")}}class I extends Error{constructor({kind:e,id:t}){super(`flow-view ${e} not found id=${t}`)}}export{V as FlowViewErrorCannotCreateWebComponent};export{I as FlowViewErrorItemNotFound};const C=r=>`${r}--highlighted`,j=r=>`${r}--error`,T=r=>({transition:`${r} 117ms ease-in-out`}),U=r=>`--fv-default-${r}`,N=r=>`var(--fv-${r},var(${U(r)}))`,p={backgroundColor:N("background-color"),borderColorHighlighted:N(C("node-border-color")),borderRadius:N("border-radius"),boxShadow:N("box-shadow"),connectionColor:N("connection-color"),connectionColorHighlighted:N(C("connection-color")),errorColor:N("error-color"),fontFamily:N("font-family"),fontSize:N("font-size"),nodeBackgroundColor:N("node-background-color"),textColor:N("text-color")},q={"border-radius":"2px","font-family":"sans-serif","font-size":"16px"},J={light:$(w({},q),{"background-color":"#fefefe","connection-color":"#ccc","box-shadow":"0px 0px 7px 1px rgba(0,0,0,0.1)",[C("connection-color")]:"#717171","error-color":"#ffa600","node-background-color":"#fefefe",[C("node-border-color")]:"#717171","text-color":"#222"}),dark:$(w({},q),{"background-color":"#555","connection-color":"#aaa","box-shadow":"0px 0px 7px 1px rgba(117,117,117,0.7)",[C("connection-color")]:"#ddd","error-color":"#ffb600","node-background-color":"#2b2b2b",[C("node-border-color")]:"#efefef","text-color":"#ccc"})},B=r=>Object.entries(J[r]).reduce((e,[t,i])=>$(w({},e),{[U(t)]:i}),{});export{C as cssModifierHighlighted};export{j as cssModifierHasError};export{T as cssTransition};export{p as cssVar};export{J as cssDefault};export{B as cssTheme};class O{static generateId(e){const t=Math.random().toString(36).replace(/[^a-z]+/g,"").substring(0,5);return e.shadowRoot.getElementById(t)?O.generateId(e):t}constructor(n){var o=n,{cssClassName:e,id:t,view:i}=o,s=Y(o,["cssClassName","id","view"]);const d=t||O.generateId(i),h=this.element=document.createElement("div");h.setAttribute("id",d),h.classList.add(e),i.shadowRoot.appendChild(h),this.view=i,this._selected=!1,this.cssClassName=e,this.init(s)}init(){}dispose(){}get bounds(){return this.element.getBoundingClientRect()}get id(){return this.element.getAttribute("id")}set ghost(e){this.element.style.opacity=e?.17:""}set hasError(e){const t=j(this.cssClassName);e?(this.element.classList.add(t),this._hasError=!0):(this.element.classList.remove(t),this._hasError=!1)}get hasError(){return this._hasError}set highlight(e){if(this.hasError)return;const t=C(this.cssClassName);e?this.element.classList.add(t):this.element.classList.remove(t)}get isSelected(){return this._selected}set selected(e){this._selected=!!e}createElement(e,t){const i=document.createElement(e);return t&&i.classList.add(t),this.element.appendChild(i),i}createSvg(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}remove(){this.dispose(),this.element.remove()}toObject(){return{id:this.id}}}export{O as FlowViewBase};const S=class extends O{init({name:e,node:t}){this.name=e,this.node=t,this.info=this.createElement("div","info"),this.text=e||"",this._onPointerdown=this.onPointerdown.bind(this),this.element.addEventListener("pointerdown",this._onPointerdown),this._onPointerenter=this.onPointerenter.bind(this),this.element.addEventListener("pointerenter",this._onPointerenter),this._onPointerleave=this.onPointerleave.bind(this),this.element.addEventListener("pointerleave",this._onPointerleave),this._onPointerup=this.onPointerup.bind(this),this.element.addEventListener("pointerup",this._onPointerup)}get offsetX(){return this.bounds.x-this.node.bounds.x}set text(e){this.info.innerHTML=e}get halfPinSize(){return Math.round(S.size/2)}dispose(){this.element.removeEventListener("pointerdown",this._onPointerdown),this.element.removeEventListener("pointerenter",this._onPointerenter),this.element.removeEventListener("pointerleave",this._onPointerleave),this.element.removeEventListener("pointerup",this._onPointerup)}onPointerenter(){this.highlight=!0}onPointerleave(){this.highlight=!1}toObject(){const e={};return this.name||(e.name=this.name),w(w({},super.toObject()),e)}};let v=S;g(v,"cssClassName","fv-pin"),g(v,"size",10),g(v,"style",{[`.${S.cssClassName}`]:w({"background-color":p.connectionColor,cursor:"none",position:"relative",display:"block",width:`${S.size}px`,height:`${S.size}px`},T("background-color")),[`.${S.cssClassName} .info`]:{visibility:"hidden",position:"absolute","font-family":"monospace","user-select":"none"},[`.${S.cssClassName}:hover .info`]:{visibility:"visible"},[`.${C(S.cssClassName)}`]:{"background-color":p.connectionColorHighlighted}});export{v as FlowViewPin};class K extends v{constructor(e){super(e),this.info.style.top="-25px"}get center(){return{x:this.node.position.x+this.halfPinSize+this.node.borderWidth+this.offsetX,y:this.node.position.y+this.halfPinSize-this.node.borderWidth}}get connectedEdge(){return[...this.view.edgesMap.values()].map(e=>e.toObject()).find(({to:[e,t]})=>e===this.node.id&&t===this.id)}onPointerdown(e){e.stopPropagation()}onPointerup(){const{connectedEdge:e,view:t}=this;if(t.isDraggingEdge){const{semiEdge:i}=t;if(i.hasSourcePin){const{source:s}=i;if(e){if(s.node.id===e.from[0]&&s.id===e.from[1])return;t.deleteEdge(e.id)}if(s.node.id===this.node.id)return;t.newEdge({source:s,target:this})}}}}class H extends v{constructor(e){super(e),this.info.style.top="15px"}get center(){return{x:this.node.position.x+this.halfPinSize+this.node.borderWidth+this.offsetX,y:this.node.position.y+this.node.bounds.height-this.halfPinSize-this.node.borderWidth}}onPointerdown(e){e.isBubblingFromPin=!0,this.view.createSemiEdge({source:this})}onPointerup(e){e.stopPropagation()}}const z=class extends O{get hasSourcePin(){return this.source instanceof H}get hasTargetPin(){return this.target instanceof K}get isSemiEdge(){return!this.hasTargetPin||!this.hasSourcePin}init({source:e,target:t}){const i=e instanceof H,s=t instanceof K;this.source=s&&!i?{center:{x:t.center.x,y:t.center.y}}:e,this.target=i&&!s?{center:{x:e.center.x,y:e.center.y}}:t;const n=this.svg=this.createSvg("svg");this.element.appendChild(n);const o=this.line=this.createSvg("line");n.appendChild(o),this.updateGeometry(),this._onDblclickLine=this.onDblclickLine.bind(this),o.addEventListener("dblclick",this._onDblclickLine),this._onPointerdownLine=this.onPointerdownLine.bind(this),o.addEventListener("pointerdown",this._onPointerdownLine),this._onPointerenterLine=this.onPointerenterLine.bind(this),o.addEventListener("pointerenter",this._onPointerenterLine),this._onPointerleaveLine=this.onPointerleaveLine.bind(this),o.addEventListener("pointerleave",this._onPointerleaveLine)}dispose(){this.line.removeEventListener("dblclick",this._onDblclickLine),this.line.removeEventListener("pointerdown",this._onPointerdownLine),this.line.removeEventListener("pointerenter",this._onPointerenterLine),this.line.removeEventListener("pointerleave",this._onPointerleaveLine)}onDblclickLine(e){e.stopPropagation(),this.view.deleteEdge(this.id)}onPointerdownLine(e){if(e.stopPropagation(),this.isSemiEdge)return;e.shiftKey||this.view.clearSelection(),this.view.selectEdge(this)}onPointerenterLine(){this.isSemiEdge||this.view.isDraggingEdge||this.isSelected||(this.highlight=!0,this.source.highlight=!0,this.target.highlight=!0)}onPointerleaveLine(){this.isSemiEdge||this.isSelected||(this.highlight=!1,this.source.node.isSelected||(this.source.highlight=!1),this.target.node.isSelected||(this.target.highlight=!1))}updateGeometry(){const{element:e,line:t,svg:i,source:{center:{x:s,y:n}},target:{center:{x:o,y:d}},view:{origin:{x:h,y:u}}}=this,{size:c}=v,l=c/2,m=o<s,a=d<n,f=(a?d-l:n-l)-u,x=(m?o-l:s-l)-h;e.style.top=`${f}px`,e.style.left=`${x}px`;const D=m?s-o+c:o-s+c;e.style.width=`${D}px`,i.setAttribute("width",D);const _=a?n-d+c:d-n+c;e.style.height=`${_}px`,i.setAttribute("height",_);const Q=m?D-l:l,Z=a?_-l:l,F=m?l:D-l,ee=a?l:_-l;t.setAttribute("x2",F),t.setAttribute("y2",ee),t.setAttribute("x1",Q),t.setAttribute("y1",Z)}toObject(){if(!this.isSemiEdge)return $(w({},super.toObject()),{from:[this.source.node.id,this.source.id],to:[this.target.node.id,this.target.id]})}};let P=z;g(P,"cssClassName","fv-edge"),g(P,"lineWidth",2),g(P,"zIndex",0),g(P,"style",{[`.${z.cssClassName}`]:{display:"flex",position:"absolute",border:0,"pointer-events":"none"},[`.${z.cssClassName} line`]:w({"pointer-events":"all",stroke:p.connectionColor,"stroke-width":z.lineWidth},T("stroke")),[`.${j(z.cssClassName)} line`]:{stroke:p.errorColor},[`.${C(z.cssClassName)} line`]:{stroke:p.connectionColorHighlighted}});export{P as FlowViewEdge};const E=class extends O{init(e){const{text:t,type:i,inputs:s=[],outputs:n=[],x:o,y:d}=e;this.text=t,this.type=i,this.borderWidth=E.borderWidth,this.inputsMap=new Map,this.inputsDiv=this.createElement("div","pins");for(const h of s)this.newInput(h);this.initContent(e),this.outputsMap=new Map,this.outputsDiv=this.createElement("div","pins");for(const h of n)this.newOutput(h);this.position={x:o,y:d},this._onDblclick=this.onDblclick.bind(this),this.element.addEventListener("dblclick",this._onDblclick),this._onPointerdown=this.onPointerdown.bind(this),this.element.addEventListener("pointerdown",this._onPointerdown)}initContent(e){const t=this.createElement("div","content");t.textContent=e.text,this.contentDiv=t}dispose(){this.element.removeEventListener("dblclick",this._onDblclick),this.element.removeEventListener("pointerdown",this._onPointerdown)}get inputs(){return[...this.inputsMap.values()]}get outputs(){return[...this.outputsMap.values()]}get position(){return{x:this.x,y:this.y}}set position({x:e=0,y:t=0}={}){const{element:i,view:s}=this;this.x=e,this.y=t,i.style.top=`${t-s.origin.y}px`,i.style.left=`${e-s.origin.x}px`}deleteInput(e){this.inputsMap.get(e).remove(),this.inputsMap.delete(e)}deleteOutput(e){this.outputsMap.get(e).remove(),this.outputsMap.delete(e)}input(e){if(!this.inputsMap.has(e))throw new I({kind:"input",id:e});return this.inputsMap.get(e)}output(e){if(!this.outputsMap.has(e))throw new I({kind:"output",id:e});return this.outputsMap.get(e)}newInput({id:e,name:t}){const i=new K({id:e,name:t,node:this,view:this.view,cssClassName:v.cssClassName});this.inputsMap.set(i.id,i),this.inputsDiv.appendChild(i.element)}newOutput({id:e,name:t}){const i=new H({id:e,name:t,node:this,view:this.view,cssClassName:v.cssClassName});this.outputsMap.set(i.id,i),this.outputsDiv.appendChild(i.element)}onDblclick(e){e.stopPropagation()}onPointerdown(e){if(e.isBubblingFromPin)return;e.isBubblingFromNode=!0,e.shiftKey||this.view.hasSelectedNodes&&this.isSelected||this.view.clearSelection(),this.view.selectNode(this)}toObject(){const{text:e,inputs:t,outputs:i,x:s,y:n}=this;return $(w(w($(w({},super.toObject()),{text:e}),t.length>0?{ins:t.map(o=>o.toObject())}:{}),i.length>0?{outs:i.map(o=>o.toObject())}:{}),{x:s,y:n})}};let L=E;g(L,"cssClassName","fv-node"),g(L,"borderWidth",1),g(L,"minSize",v.size*4),g(L,"zIndex",P.zIndex+1),g(L,"style",{[`.${E.cssClassName}`]:w({position:"absolute","background-color":p.nodeBackgroundColor,"border-radius":p.borderRadius,"box-shadow":p.boxShadow,display:"flex","flex-direction":"column","justify-content":"space-between",border:`${E.borderWidth}px solid transparent`,"min-height":`${E.minSize}px`,"min-width":`${E.minSize}px`,width:"fit-content","z-index":E.zIndex},T("border-color")),[`.${C(E.cssClassName)}`]:{"border-color":p.borderColorHighlighted},[`.${j(E.cssClassName)}`]:{"border-color":p.errorColor},[`.${E.cssClassName} .content`]:{"user-select":"none","padding-left":"0.5em","padding-right":"0.5em","text-align":"center"},[`.${E.cssClassName} .pins`]:{display:"flex","flex-direction":"row",gap:`${v.size}px`,"justify-content":"space-between",height:`${v.size}px`}});export{L as FlowViewNode};const b=class extends O{init({nodeNames:e,position:t}){const{element:i}=this;i.setAttribute("tabindex",0),this.hint=this.createElement("input",`${b.cssClassName}__hint`);const s=this.input=this.createElement("input");this.options=this.createElement("div",[`${b.cssClassName}__options`]),this.nodeNames=e,this.position=t,this.highlightedOptionIndex=-1,this._onDblclick=this.onDblclick.bind(this),i.addEventListener("dblclick",this._onDblclick),this._onPointerdown=this.onPointerdown.bind(this),i.addEventListener("pointerdown",this._onPointerdown),this._onPointerleave=this.onPointerleave.bind(this),i.addEventListener("pointerleave",this._onPointerleave),this._onKeydown=this.onKeydown.bind(this),s.addEventListener("keydown",this._onKeydown),this._onKeyup=this.onKeyup.bind(this),s.addEventListener("keyup",this._onKeyup)}dispose(){const{element:e,input:t}=this;e.removeEventListener("dblclick",this._onDblclick),e.removeEventListener("pointerdown",this._onPointerdown),e.removeEventListener("pointerleave",this._onPointerdown),t.removeEventListener("keydown",this._onKeydown),t.removeEventListener("keyup",this._onKeyup)}focus(){this.input.focus()}get completion(){return this.hint.getAttribute("placeholder")}set completion(e){this.hint.setAttribute("placeholder",e)}get matchingNodes(){const e=this.input.value.toLowerCase();return e.length===0?[]:this.nodeNames.filter(t=>t.toLowerCase().startsWith(e)&&t.toLowerCase()!==e)}set position({x:e,y:t}){const{element:i,view:s}=this,n=t-s.origin.y+40>=s.height,d=e-s.origin.x+b.width>=s.width?s.width+s.origin.x-b.width-10:e,h=n?s.height+s.origin.y-50:t;i.style.top=`${h-s.origin.y}px`,i.style.left=`${d-s.origin.x}px`,this.x=d,this.y=h}get position(){return{x:this.x,y:this.y}}createNode(){var i,s,n,o;const e=(o=(n=(s=(i=this.options)==null?void 0:i.children)==null?void 0:s[this.highlightedOptionIndex])==null?void 0:n.textContent)!=null?o:this.input.value,t=this.nodeNames.find(([d])=>d.toLowerCase()===e.toLowerCase());this.view.newNode({x:this.position.x,y:this.position.y,text:t!=null?t:e}),this.view.removeSelector()}onDblclick(e){e.stopPropagation()}onKeyup(e){e.stopPropagation();const t=`${b.cssClassName}__option--highlighted`,i=()=>{for(let a=0;a<this.options.childElementCount;a++){const f=this.options.children[a];this.highlightedOptionIndex===a?f.classList.add(t):f.classList.remove(t)}},s=()=>{this.highlightedOptionIndex=Math.min(this.highlightedOptionIndex+1,this.options.childElementCount-1)},n=()=>{this.highlightedOptionIndex=this.highlightedOptionIndex!==-1?Math.max(this.highlightedOptionIndex-1,0):-1},o=()=>{for(;this.options.firstChild;)this.options.removeChild(this.options.lastChild)},d=()=>{this.highlightedOptionIndex=-1,o()},h=()=>{o();for(let a=0;a<this.matchingNodes.length;a++){const f=this.matchingNodes[a],x=document.createElement("div");x.classList.add(`${b.cssClassName}__option`),x.textContent=f,x.onclick=()=>{this.input.value=f,this.createNode()},x.onpointerenter=()=>{this.highlightedOptionIndex=a,x.classList.add(t)},x.onpointerleave=()=>{x.classList.remove(t)},this.options.append(x)}},u=()=>{switch(this.matchingNodes.length){case 0:this.completion="",this.highlightedOptionIndex=-1;break;case 1:{const a=this.matchingNodes[0];a.includes(this.input.value)&&(this.completion=a);break}default:if(this.highlightedOptionIndex===-1){this.completion=this.input.value;const a=this.matchingNodes.reduce((f,x)=>f.length<x.length?f:x);for(let f=this.input.value.length;f<a.length;f++){const x=a[f];this.matchingNodes.every(D=>D.startsWith(this.completion+x))&&(this.completion+=x)}}else this.completion=this.options.children[this.highlightedOptionIndex].textContent}},c=()=>{this.completion&&(this.input.value=this.completion)},l=()=>this.matchingNodes.find(a=>!a.startsWith(this.input.value)&&a.toLowerCase().startsWith(this.input.value.toLowerCase())),m=()=>{const a=l();!a||(this.input.value=a.substring(0,this.input.value.length),u())};switch(e.code){case"Enter":this.createNode();break;case"Escape":this.input.value===""?this.view.removeSelector():(this.completion="",this.input.value="",d());break;case"ArrowLeft":case"ShiftLeft":case"ShiftRight":break;case"ArrowDown":m(),s(),i(),u();break;case"ArrowUp":e.preventDefault(),m(),n(),i(),u();break;case"ArrowRight":this.input.value.length===e.target.selectionStart&&(c(),d());break;case"Backspace":this.highlightedOptionIndex=-1,h(),u();break;case"Tab":{if(e.preventDefault(),m(),this.matchingNodes.length===1){u(),c(),d();break}e.shiftKey?this.highlightedOptionIndex===0?this.highlightedOptionIndex=this.options.childElementCount-1:n():this.options.childElementCount-1===this.highlightedOptionIndex?this.highlightedOptionIndex=0:s(),h(),u(),i();break}default:h(),u()}}onKeydown(e){e.stopPropagation(),["ArrowUp","Tab"].includes(e.code)&&e.preventDefault()}onPointerdown(e){e.stopPropagation()}onPointerleave(){this.highlightedOptionIndex=-1}};let y=b;g(y,"cssClassName","fv-selector"),g(y,"zIndex",L.zIndex+1),g(y,"width",170),g(y,"padding",9),g(y,"style",{[`.${b.cssClassName}`]:{position:"absolute","box-shadow":p.boxShadow,"z-index":b.zIndex},[`.${b.cssClassName} input`]:{border:0,margin:0,outline:0,"border-radius":p.borderRadius,"font-family":p.fontFamily,"font-size":p.fontSize,padding:`${b.padding}px`,width:`${b.width-2*b.padding}px`},[`.${b.cssClassName}__hint`]:{position:"absolute",left:"0",background:"transparent","pointer-events":"none"},[`.${b.cssClassName}__hint::placeholder`]:{opacity:"0.4"},[`.${b.cssClassName}__options`]:{"background-color":p.nodeBackgroundColor,height:"fit-content"},[`.${b.cssClassName}__option`]:w({padding:"0.5em",border:"1px solid transparent",cursor:"default"},T("border-color")),[`.${b.cssClassName}__option--highlighted`]:{"border-color":p.borderColorHighlighted}});const M=class extends HTMLElement{static generateStylesheet(e){return Object.entries(e).reduce((t,[i,s])=>[t,`${i}{`,Object.entries(s).map(([n,o])=>`${n}:${o};`).join(""),"}"].join(""),"")}static pointerCoordinates(e){const{clientX:t,clientY:i,target:s}=e,{left:n,top:o}=s.getBoundingClientRect();return{x:Math.round(t-n),y:Math.round(i-o)}}constructor(){super();const e=document.createElement("template"),t=this.hasAttribute("light"),i=this.hasAttribute("dark"),s=t&&!i,n=!t&&i,{generateStylesheet:o}=M,d=o({":host":B("light")}),h=o({":host":B("dark")});e.innerHTML=["<style>",o(M.style),o({":host":{"color-scheme":s?"light":n?"dark":"light dark"}}),...s?d:n?h:[d,`@media(prefers-color-scheme:dark){${h}}`],"</style>"].join(""),this.attachShadow({mode:"open"}).appendChild(e.content.cloneNode(!0)),this._origin={x:0,y:0},this.nodesMap=new Map,this.edgesMap=new Map,this.itemClassMap=new Map,Object.entries(M.defaultItems).forEach(([u,c])=>{this.itemClassMap.set(u,c)}),this.selectorId=`selector-${O.generateId(this)}`}connectedCallback(){"ResizeObserver"in window?(this.rootResizeObserver=new ResizeObserver(this.onRootResize.bind(this)),this.rootResizeObserver.observe(this.parentNode)):this.height=this.getAttribute("height")||M.minHeight,this.getAttribute("tabindex")||this.setAttribute("tabindex",0),this.addEventListener("contextmenu",this.onContextmenu),this.addEventListener("dblclick",this.onDblclick),this.addEventListener("keydown",this.onKeydown),this.addEventListener("pointerdown",this.onPointerdown),this.addEventListener("pointermove",this.onPointermove),this.addEventListener("pointerleave",this.onPointerleave),this.addEventListener("pointerup",this.onPointerup)}disconnectedCallback(){this.removeResizeObserver(),this.removeEventListener("contextmenu",this.onContextmenu),this.removeEventListener("dblclick",this.onDblclick),this.removeEventListener("keydown",this.onKeydown),this.removeEventListener("pointerdown",this.onPointerdown),this.removeEventListener("pointermove",this.onPointermove),this.removeEventListener("pointerleave",this.onPointerleave),this.removeEventListener("pointerup",this.onPointerup)}removeResizeObserver(){var e;this.parentNode&&((e=this.rootResizeObserver)==null||e.unobserve(this.parentNode)),delete this.rootResizeObserver}get origin(){return this.translateVector&&!this.hasSelectedNodes?{x:this._origin.x+this.translateVector.x,y:this._origin.y+this.translateVector.y}:this._origin}get selectedEdges(){return this.edges.filter(e=>e.isSelected)}get hasSelectedNodes(){return this.selectedNodes.length>0}get isDraggingEdge(){return this.semiEdge instanceof P}get selectedNodeIds(){return this.selectedNodes.map(e=>e.id)}get selectedNodes(){return this.nodes.filter(e=>e.isSelected)}get edges(){return[...this.edgesMap.values()]}get nodes(){return[...this.nodesMap.values()]}get height(){return parseInt(this.style.height)}set height(e){this.style.height=`${e}px`}get width(){return parseInt(this.style.width)}set width(e){this.style.width=`${e}px`}clear(e){this.nodes.forEach(t=>{this.deleteNode(t.id,e)})}newEdge({id:e,source:t,target:i},s){const n=this.itemClassMap.get("edge"),o=new n({id:e,view:this,cssClassName:n.cssClassName,source:t,target:i});return this.edgesMap.set(o.id,o),this.host.viewChange({createdEdge:o.toObject()},s),o}newNode({x:e=0,y:t=0,text:i,id:s,type:n,ins:o=[],outs:d=[]},h){var m,a,f;const u=(a=(m=this.host.textToType(i))!=null?m:this.host.nodeNameTypeMap.get(i))!=null?a:n,c=(f=this.itemClassMap.get(u))!=null?f:this.itemClassMap.get("node"),l=new c({id:s,view:this,cssClassName:c.cssClassName,text:i,inputs:o,outputs:d,x:e,y:t,type:u});return this.nodesMap.set(l.id,l),this.host.viewChange({createdNode:l.toObject()},h),l}selectEdge(e){e.highlight=!0,e.selected=!0,e.source.highlight=!0,e.target.highlight=!0}selectNode(e){e.highlight=!0,e.selected=!0;for(const t of this.edges)t.source.node.isSelected&&t.target.node.isSelected?this.selectEdge(t):this.deselectEdge(t)}deselectEdge(e){e.highlight=!1,e.selected=!1,e.source.node.isSelected||(e.source.highlight=!1),e.target.node.isSelected||(e.target.highlight=!1)}deselectNode(e){e.highlight=!1,e.selected=!1;for(const t of e.inputs)t.highlight=!1;for(const t of e.outputs)t.highlight=!1}deleteEdge(e,t){const i=this.edgesMap.get(e);if(!i)return;i.source.highlight=!1,i.target.highlight=!1,this.edgesMap.delete(i.id),i.remove();const s=i.toObject();return this.host.viewChange({deletedEdge:s},t),s}deleteNode(e,t){const i=this.nodesMap.get(e);if(!i)return;for(const n of this.edges)(n.source.node.id===i.id||n.target.node.id===i.id)&&this.deleteEdge(n.id,t);this.nodesMap.delete(i.id),i.remove();const s=i.toObject();return this.host.viewChange({deletedNode:s},t),s}edge(e){if(!this.edgesMap.has(e))throw new I({kind:"edge",id:e});return this.edgesMap.get(e)}node(e){if(!this.nodesMap.has(e))throw new I({kind:"node",id:e});return this.nodesMap.get(e)}enableBodyScroll(){document.body.style.overflow=this._bodyOverflow}disableBodyScroll(){this._bodyOverflow=document.body.style.overflow,document.body.style.overflow="hidden"}startTranslation(e){if(this.disableBodyScroll(),this.startDraggingPoint=M.pointerCoordinates(e),this.translateVector={x:0,y:0},this.hasSelectedNodes){const t={};for(const i of this.selectedNodes)t[i.id]=i.position;this.selectedNodesStartPosition=t}}stopTranslation(){this.translateVector&&!this.hasSelectedNodes&&!this.semiEdge&&(this._origin={x:this._origin.x+this.translateVector.x,y:this._origin.y+this.translateVector.y}),delete this.translateVector,delete this.startDraggingPoint,delete this.selectedNodesStartPosition,this.enableBodyScroll()}createSelector({position:e}){return this.selector=new y({id:this.selectorId,view:this,cssClassName:y.cssClassName,position:e,nodeNames:[...this.host.nodeNameTypeMap.keys()]})}updateNode({node:e}){this.host.viewChange({updatedNode:e.toObject()},viewChangeInfo)}onContextmenu(e){e.preventDefault()}onDblclick(e){this.clearSelection(),this.removeSelector();const t=M.pointerCoordinates(e);this.createSelector({position:{x:t.x+this.origin.x,y:t.y+this.origin.y}}).focus()}onKeydown(e){switch(e.stopPropagation(),!0){case this.selector instanceof y:return;case e.code==="Backspace":this.deleteSelectedItems();break;case e.code==="Escape":this.clearSelection();break;default:break}}onPointerdown(e){e.stopPropagation(),this.removeSelector(),e.isBubblingFromNode||this.clearSelection(),e.shiftKey||this.startTranslation(e)}onPointermove(e){const{hasSelectedNodes:t,semiEdge:i,startDraggingPoint:s}=this;if(s){const n=M.pointerCoordinates(e),o=s.x-n.x,d=s.y-n.y;switch(!0){case!!i:{i.hasTarget||(i.target.center.x=n.x+this.origin.x,i.target.center.y=n.y+this.origin.y),i.updateGeometry();break}case t:{this.translateVector={x:o,y:d};const{edges:h,selectedNodes:u,selectedNodeIds:c,selectedNodesStartPosition:l}=this;for(const m of u){const{x:a,y:f}=l[m.id];m.position={x:a-o,y:f-d}}for(const m of h)(c.includes(m.source.node.id)||c.includes(m.target.node.id))&&m.updateGeometry();break}default:{this.translateVector={x:o,y:d};const{nodes:h,edges:u}=this;for(const c of h){const{x:l,y:m}=c.position;c.position={x:l,y:m}}for(const c of u)c.updateGeometry()}}}}onPointerleave(){this.stopTranslation(),this.removeSemiEdge()}onPointerup(){this.stopTranslation(),this.removeSemiEdge()}onRootResize(e){for(const t of e)if(this.parentNode===t.target){const i=Array.isArray(t.contentBoxSize)?t.contentBoxSize[0]:t.contentBoxSize;i?(this.width=i.inlineSize,this.height=i.blockSize):t.contentRect&&(this.width=t.contentRect.width,this.height=t.contentRect.height)}}createSemiEdge({source:e,target:t},i){const s=this.itemClassMap.get("edge");this.semiEdge=new s({view:this,cssClassName:s.cssClassName,source:e,target:t}),this.host.viewChange({createdSemiEdge:{from:e instanceof v?[e.node.id,e.id]:void 0,to:t instanceof v?[t.node.id,t.id]:void 0}},i)}clearSelection(){for(const e of this.selectedNodes)this.deselectNode(e);for(const e of this.selectedEdges)this.deselectEdge(e)}deleteSelectedItems(){for(const e of this.selectedEdges)this.deleteEdge(e.id);for(const e of this.selectedNodes)this.deleteNode(e.id)}removeSemiEdge(e){if(!this.semiEdge)return;const{source:t,target:i}=this.semiEdge;this.semiEdge.remove(),delete this.semiEdge,this.host.viewChange({deletedSemiEdge:{from:t instanceof v?[t.node.id,t.id]:void 0,to:i instanceof v?[i.node.id,i.id]:void 0}},e)}removeSelector(){this.selector instanceof y&&this.selector.remove(),this.selector=void 0}};let k=M;g(k,"customElementName","flow-view"),g(k,"minHeight",200),g(k,"defaultItems",{edge:P,node:L}),g(k,"style",w(w(w(w({":host([hidden])":{display:"none"},":host":{position:"relative",display:"block",overflow:"hidden",border:0,margin:0,outline:0,"background-color":p.backgroundColor,"border-radius":p.borderRadius,"box-shadow":p.boxShadow,"font-family":p.fontFamily,"font-size":p.fontSize,color:p.textColor}},P.style),L.style),v.style),y.style));export{k as FlowViewElement};class W{static defineCustomElement(e){const{customElementName:t}=e;window.customElements.get(t)||window.customElements.define(t,e)}constructor({container:e,element:t}={}){if(W.defineCustomElement(k),t instanceof k)t.host=this,this.view=t;else if(e instanceof HTMLElement){const i=this.view=document.createElement(k.customElementName);i.host=this,e.appendChild(i)}else throw new V;this.view.style.isolation="isolate",this.nodeNameTypeMap=new Map,this.onViewChange=()=>{},this.textToType=()=>{}}get graph(){const{view:{nodes:e,edges:t}}=this;return{nodes:e.map(i=>i.toObject()),edges:t.map(i=>i.toObject())}}destroy(){this.view.parentNode.removeChild(this.view)}node(e){return this.view.node(e)}edge(e){return this.view.edge(e)}addNodeDefinitions({nodes:e}){e.forEach(({name:t,type:i})=>this.nodeNameTypeMap.set(t,i))}clearGraph(){this.view.clear({isClearGraph:!0})}loadGraph({nodes:e=[],edges:t=[]}){for(const i of e)this.newNode(i,{isLoadGraph:!0});for(const i of t)this.newEdge(i,{isLoadGraph:!0})}onChange(e){this.onViewChange=e}viewChange({createdNode:e,createdEdge:t,createdSemiEdge:i,deletedNode:s,deletedEdge:n,deletedSemiEdge:o,updatedNode:d},h={}){e&&this.onViewChange({action:"CREATE_NODE",data:e},h),t&&this.onViewChange({action:"CREATE_EDGE",data:t},h),i&&this.onViewChange({action:"CREATE_SEMI_EDGE",data:i},h),s&&this.onViewChange({action:"DELETE_NODE",data:s},h),n&&this.onViewChange({action:"DELETE_EDGE",data:n},h),o&&this.onViewChange({action:"DELETE_SEMI_EDGE",data:o},h),d&&this.onViewChange({action:"UPDATE_NODE",data:d},h)}newEdge({id:e,from:[t,i],to:[s,n]},o={isProgrammatic:!0}){const d=this.view.node(t),h=this.view.node(s),u=d.output(i),c=h.input(n);return this.view.newEdge({id:e,source:u,target:c},o)}newNode(e,t={isProgrammatic:!0}){return this.view.newNode(e,t)}deleteNode(e,t={isProgrammatic:!0}){return this.view.deleteNode(e,t)}deleteEdge(e,t={isProgrammatic:!0}){return this.view.deleteEdge(e,t)}addNodeClass(e,t){this.view.itemClassMap.set(e,t)}nodeTextToType(e){this.textToType=e}}export{W as FlowView};
