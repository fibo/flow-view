<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/x-icon;base64,AA">
  <meta name="viewport" content="width=device-width" />

  <title>flow-view</title>
  <meta name="description" content="is a visual editor for Dataflow programming">

  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <main>
    <h1>flow-view</h1>

    <blockquote>is a visual editor for <em>dataflow programming</em></blockquote>

      <ul>
        <li>Drag on canvas to translate all items.</li>
        <li>Click on item to select it.</li>
        <li>Click while pressing <kbd>SHIFT</kbd> to enable <b>multi</b> selection.</li>
        <li>Drag from a node output to a node input to create an edge.</li>
        <li>Drag selected items to translate them.</li>
        <li>Press <kbd>BACKSPACE</kbd> to delete selected items.</li>
        <li>Double click on canvas to open the <b>selector</b>.</li>
        <li>Type into the selector then press <kbd>ENTER</kbd> to create a new node.</li>
      </ul>

    <div class="container">
    </div>

    <div class="controls">
      <button id="reset">Reset</button>
      <button id="clear">Clear</button>
      <button id="save">Save</button>
    </div>

    <a hidden href="" id="download" download="graph.json"></a>

    <section>
      <h2>examples</h2>
      <ul>
        <li><a href="./examples/programmatic/demo.html">programmatic</a></li>
        <li><a href="./examples/custom-node/demo.html">custom node</a></li>
      </ul>
    </section>
  </main>

  <script type="module">
    import { FlowView } from 'https://unpkg.com/flow-view';
    // import { FlowView } from './main.js';

    const flowView = new FlowView({
      container: document.querySelector('.container')
    });

    const nodeLabels = [
      "Marge",
      "Homer",
      "Bart",
      "Lisa",
      "Barney",
      "Milhouse",
      "Moe",
      "Ned",
      "Patty",
      "Ralph",
      "Selma",
      "Mr. Burns"
    ];
    flowView.addNodeLabels(nodeLabels);

    flowView.onChange(({ action, data }) => {
      switch(action) {
        case 'CREATE_NODE': {
          const node = flowView.node(data.id);

          // Make it case insensitive.
          const label = nodeLabels.find((nodeLabel) => {
            return (nodeLabel.toLowerCase() === data.label.toLowerCase());
          }) || data.label;
          node.label = label

          switch (label) {
            case 'Marge':
            case 'Homer': {
              if (node.outputs.length === 0) {
                node.newOutput({})
              }
              node.outputs[0].text = 'out'
              break;
            }

            case 'Bart':
            case 'Lisa': {
              if (node.inputs.length === 0) {
                node.newInput({});
                node.newInput({});
              }
              node.inputs[0].text = 'in1'
              node.inputs[1].text = 'in2'
              break;
            }

            default: {
              console.log('Unknown node', node);
            }
          }
        }

        default: {
          console.log(action, data);
        }
      }
    })

    const initialGraph = {
      nodes: [
        {
          id: 'dad',
          label: 'Homer',
          x: 60, y: 70,
          outputs: [{ id: 'children' }]
        },
        {
          id: 'mom',
          label: 'Marge',
          x: 160, y: 70,
          outputs: [{ id: 'children' }]
        },
        {
          id: 'son',
          label: 'Bart',
          x: 60, y: 240,
          inputs: [{ id: 'father' }, { id: 'mother' }]
        },
        {
          id: 'daughter',
          label: 'Lisa',
          x: 220, y: 220,
          inputs: [{ id: 'father' }, { id: 'mother' }]
        }
      ],
      edges: [
        { from: ['dad', 'children'], to: ['son', 'father'] },
        { from: ['dad', 'children'], to: ['daughter', 'father'] },
        { from: ['mom', 'children'], to: ['son', 'mother'] },
        { from: ['mom', 'children'], to: ['daughter', 'mother'] }
      ]
    }

    flowView.loadGraph(initialGraph);

    // Few tests.
    try {
      console.log('not a node', flowView.node('xxx'));
    } catch (error) {
      console.log('THIS IS A TEST:', error.message)
    }
    try {
      console.log('not an edge', flowView.edge('xxx'));
    } catch (error) {
      console.log('THIS IS A TEST:', error.message)
    }
    console.log('Homer node', flowView.node('dad'));
    flowView.graph.edges.slice(0, 1).forEach(({ id }) => {
      console.log('First edge', flowView.edge(id));
    });

    // Controls

    const resetButton = document.querySelector('button#reset');
    resetButton.addEventListener('click', () => {
      flowView.clearGraph();
      flowView.loadGraph(initialGraph);
    })

    const clearButton = document.querySelector('button#clear');
    clearButton.addEventListener('click', () => {
      flowView.clearGraph();
    })

    const downloadGraph = document.querySelector('a#download');
    const saveButton = document.querySelector('button#save');
    saveButton.addEventListener('click', () => {
      downloadGraph.setAttribute('href', `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(flowView.graph))}`);
      downloadGraph.click();
    })
  </script>

  <footer>
    GitHub: <a href="https://github.com/fibo/flow-view">fibo/flow-view</a>
  </footer>
</body>
</html>
