var ne=Object.defineProperty,re=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var V=(r,e,t)=>e in r?ne(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,p=(r,e)=>{for(var t in e||(e={}))Q.call(e,t)&&V(r,t,e[t]);if(H)for(var t of H(e))Z.call(e,t)&&V(r,t,e[t]);return r},z=(r,e)=>re(r,he(e));var F=(r,e)=>{var t={};for(var i in r)Q.call(r,i)&&e.indexOf(i)<0&&(t[i]=r[i]);if(r!=null&&H)for(var i of H(r))e.indexOf(i)<0&&Z.call(r,i)&&(t[i]=r[i]);return t};var m=(r,e,t)=>(V(r,typeof e!="symbol"?e+"":e,t),t);class ee extends TypeError{constructor(){super("flow-view was provided with no valid element nor container")}}class te extends Error{constructor(){super("flow-view cannot load style for custom element")}}class T extends Error{constructor({kind:e,id:t}){super(`flow-view ${e} not found id=${t}`)}}export{ee as FlowViewErrorCannotCreateWebComponent};export{te as FlowViewErrorCannotLoadStyle};export{T as FlowViewErrorItemNotFound};const N=r=>`${r}--highlighted`,W=r=>`${r}--error`,j=r=>({transition:`${r} 117ms ease-in-out`}),ie=r=>`--fv-default-${r}`,P=r=>`var(--fv-${r},var(${ie(r)}))`,g={backgroundColor:P("background-color"),borderColorHighlighted:P(N("node-border-color")),borderRadius:P("border-radius"),boxShadow:P("box-shadow"),connectionColor:P("connection-color"),connectionColorHighlighted:P(N("connection-color")),errorColor:P("error-color"),fontFamily:P("font-family"),fontSize:P("font-size"),nodeBackgroundColor:P("node-background-color"),textColor:P("text-color")},se={"border-radius":"2px","font-family":"sans-serif","font-size":"16px"},oe={light:z(p({},se),{"background-color":"#fefefe","connection-color":"#ccc","box-shadow":"0px 0px 7px 1px rgba(0,0,0,0.1)",[N("connection-color")]:"#717171","error-color":"#ffa600","node-background-color":"#fefefe",[N("node-border-color")]:"#717171","text-color":"#222"}),dark:z(p({},se),{"background-color":"#555","connection-color":"#aaa","box-shadow":"0px 0px 7px 1px rgba(117,117,117,0.7)",[N("connection-color")]:"#ddd","error-color":"#ffb600","node-background-color":"#2b2b2b",[N("node-border-color")]:"#efefef","text-color":"#ccc"})},Y=r=>Object.entries(oe[r]).reduce((e,[t,i])=>z(p({},e),{[ie(t)]:i}),{});export{N as cssModifierHighlighted};export{W as cssModifierHasError};export{j as cssTransition};export{g as cssVar};export{oe as cssDefault};export{Y as cssTheme};class ${static generateId(e){const t=Math.random().toString(36).replace(/[^a-z]+/g,"").substring(0,5);return e.shadowRoot.getElementById(t)?$.generateId(e):t}constructor(n){var o=n,{cssClassName:e,id:t,view:i}=o,s=F(o,["cssClassName","id","view"]);const a=t||$.generateId(i),h=this.element=document.createElement("div");h.setAttribute("id",a),h.classList.add(e),i.shadowRoot.appendChild(h),this.view=i,this._selected=!1,this.cssClassName=e,this.init(s)}init(){}dispose(){}get bounds(){return this.element.getBoundingClientRect()}get id(){return this.element.getAttribute("id")}set ghost(e){this.element.style.opacity=e?.17:""}set hasError(e){const t=W(this.cssClassName);e?(this.element.classList.add(t),this._hasError=!0):(this.element.classList.remove(t),this._hasError=!1)}get hasError(){return this._hasError}set highlight(e){if(this.hasError)return;const t=N(this.cssClassName);e?this.element.classList.add(t):this.element.classList.remove(t)}get isSelected(){return this._selected}set selected(e){this._selected=!!e}createElement(e,t){const i=document.createElement(e);return t&&i.classList.add(t),this.element.appendChild(i),i}createSvg(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}remove(){this.dispose(),this.element.remove()}toObject(){return{id:this.id}}}export{$ as FlowViewBase};const M=class extends ${init({name:e,node:t}){this.name=e,this.node=t,this.info=this.createElement("div","info"),this.text=e||"",this._onPointerdown=this.onPointerdown.bind(this),this.element.addEventListener("pointerdown",this._onPointerdown),this._onPointerenter=this.onPointerenter.bind(this),this.element.addEventListener("pointerenter",this._onPointerenter),this._onPointerleave=this.onPointerleave.bind(this),this.element.addEventListener("pointerleave",this._onPointerleave),this._onPointerup=this.onPointerup.bind(this),this.element.addEventListener("pointerup",this._onPointerup)}get offsetX(){return this.bounds.x-this.node.bounds.x}set text(e){this.info.innerHTML=e}get halfPinSize(){return Math.round(M.size/2)}dispose(){this.element.removeEventListener("pointerdown",this._onPointerdown),this.element.removeEventListener("pointerenter",this._onPointerenter),this.element.removeEventListener("pointerleave",this._onPointerleave),this.element.removeEventListener("pointerup",this._onPointerup)}onPointerenter(){this.highlight=!0}onPointerleave(){this.highlight=!1}toObject(){const e={};return this.name||(e.name=this.name),p(p({},super.toObject()),e)}};let b=M;m(b,"cssClassName","fv-pin"),m(b,"size",10),m(b,"style",{[`.${M.cssClassName}`]:p({"background-color":g.connectionColor,cursor:"none",position:"relative",display:"block",width:`${M.size}px`,height:`${M.size}px`},j("background-color")),[`.${M.cssClassName} .info`]:{visibility:"hidden",position:"absolute","font-family":"monospace","user-select":"none"},[`.${M.cssClassName}:hover .info`]:{visibility:"visible"},[`.${N(M.cssClassName)}`]:{"background-color":g.connectionColorHighlighted}});export{b as FlowViewPin};class U extends b{constructor(e){super(e),this.info.style.top="-25px"}get center(){return{x:this.node.position.x+this.halfPinSize+this.node.borderWidth+this.offsetX,y:this.node.position.y+this.halfPinSize-this.node.borderWidth}}get connectedEdge(){return[...this.view.edgesMap.values()].map(e=>e.toObject()).find(({to:[e,t]})=>e===this.node.id&&t===this.id)}onPointerdown(e){e.stopPropagation()}onPointerup(){const{connectedEdge:e,view:t}=this;if(t.isDraggingEdge){const{semiEdge:i}=t;if(i.hasSourcePin){const{source:s}=i;if(e){if(s.node.id===e.from[0]&&s.id===e.from[1])return;t.deleteEdge(e.id)}if(s.node.id===this.node.id)return;t.newEdge({source:s,target:this})}}}}class q extends b{constructor(e){super(e),this.info.style.top="15px"}get center(){return{x:this.node.position.x+this.halfPinSize+this.node.borderWidth+this.offsetX,y:this.node.position.y+this.node.bounds.height-this.halfPinSize-this.node.borderWidth}}onPointerdown(e){e.isBubblingFromPin=!0,this.view.createSemiEdge({source:this})}onPointerup(e){e.stopPropagation()}}const I=class extends ${get hasSourcePin(){return this.source instanceof q}get hasTargetPin(){return this.target instanceof U}get isSemiEdge(){return!this.hasTargetPin||!this.hasSourcePin}init({source:e,target:t}){const i=e instanceof q,s=t instanceof U;this.source=s&&!i?{center:{x:t.center.x,y:t.center.y}}:e,this.target=i&&!s?{center:{x:e.center.x,y:e.center.y}}:t;const n=this.svg=this.createSvg("svg");this.element.appendChild(n);const o=this.line=this.createSvg("line");n.appendChild(o),this.updateGeometry(),this._onDblclickLine=this.onDblclickLine.bind(this),o.addEventListener("dblclick",this._onDblclickLine),this._onPointerdownLine=this.onPointerdownLine.bind(this),o.addEventListener("pointerdown",this._onPointerdownLine),this._onPointerenterLine=this.onPointerenterLine.bind(this),o.addEventListener("pointerenter",this._onPointerenterLine),this._onPointerleaveLine=this.onPointerleaveLine.bind(this),o.addEventListener("pointerleave",this._onPointerleaveLine)}dispose(){this.line.removeEventListener("dblclick",this._onDblclickLine),this.line.removeEventListener("pointerdown",this._onPointerdownLine),this.line.removeEventListener("pointerenter",this._onPointerenterLine),this.line.removeEventListener("pointerleave",this._onPointerleaveLine)}onDblclickLine(e){e.stopPropagation(),this.view.deleteEdge(this.id)}onPointerdownLine(e){if(e.stopPropagation(),this.isSemiEdge)return;e.shiftKey||this.view.clearSelection(),this.view.selectEdge(this)}onPointerenterLine(){this.isSemiEdge||this.view.isDraggingEdge||this.isSelected||(this.highlight=!0,this.source.highlight=!0,this.target.highlight=!0)}onPointerleaveLine(){this.isSemiEdge||this.isSelected||(this.highlight=!1,this.source.node.isSelected||(this.source.highlight=!1),this.target.node.isSelected||(this.target.highlight=!1))}updateGeometry(){const{element:e,line:t,svg:i,source:{center:{x:s,y:n}},target:{center:{x:o,y:a}},view:{origin:{x:h,y:l}}}=this,{size:c}=b,f=c/2,v=o<s,d=a<n,u=(d?a-f:n-f)-l,x=(v?o-f:s-f)-h;e.style.top=`${u}px`,e.style.left=`${x}px`;const k=v?s-o+c:o-s+c;e.style.width=`${k}px`,i.setAttribute("width",k);const D=d?n-a+c:a-n+c;e.style.height=`${D}px`,i.setAttribute("height",D);const R=v?k-f:f,A=d?D-f:f,B=v?f:k-f,K=d?f:D-f;t.setAttribute("x2",B),t.setAttribute("y2",K),t.setAttribute("x1",R),t.setAttribute("y1",A)}toObject(){if(!this.isSemiEdge)return z(p({},super.toObject()),{from:[this.source.node.id,this.source.id],to:[this.target.node.id,this.target.id]})}};let L=I;m(L,"cssClassName","fv-edge"),m(L,"lineWidth",2),m(L,"zIndex",0),m(L,"style",{[`.${I.cssClassName}`]:{display:"flex",position:"absolute",border:0,"pointer-events":"none"},[`.${I.cssClassName} line`]:p({"pointer-events":"all",stroke:g.connectionColor,"stroke-width":I.lineWidth},j("stroke")),[`.${W(I.cssClassName)} line`]:{stroke:g.errorColor},[`.${N(I.cssClassName)} line`]:{stroke:g.connectionColorHighlighted}});export{L as FlowViewEdge};const C=class extends ${init(e){const{text:t,type:i,inputs:s=[],outputs:n=[],x:o,y:a}=e;this.text=t,this.type=i,this.borderWidth=C.borderWidth,this.inputsMap=new Map,this.inputsDiv=this.createElement("div","pins");for(const h of s)this.newInput(h);this.initContent(e),this.outputsMap=new Map,this.outputsDiv=this.createElement("div","pins");for(const h of n)this.newOutput(h);this.position={x:o,y:a},this._onDblclick=this.onDblclick.bind(this),this.element.addEventListener("dblclick",this._onDblclick),this._onPointerdown=this.onPointerdown.bind(this),this.element.addEventListener("pointerdown",this._onPointerdown)}initContent(e){const t=this.createElement("div","content");t.textContent=e.text,this.contentDiv=t}dispose(){this.element.removeEventListener("dblclick",this._onDblclick),this.element.removeEventListener("pointerdown",this._onPointerdown)}get inputs(){return[...this.inputsMap.values()]}get outputs(){return[...this.outputsMap.values()]}get position(){return{x:this.x,y:this.y}}set position({x:e=0,y:t=0}={}){const{element:i,view:s}=this;this.x=e,this.y=t,i.style.top=`${t-s.origin.y}px`,i.style.left=`${e-s.origin.x}px`}deleteInput(e){this.inputsMap.get(e).remove(),this.inputsMap.delete(e)}deleteOutput(e){this.outputsMap.get(e).remove(),this.outputsMap.delete(e)}input(e){if(!this.inputsMap.has(e))throw new T({kind:"input",id:e});return this.inputsMap.get(e)}output(e){if(!this.outputsMap.has(e))throw new T({kind:"output",id:e});return this.outputsMap.get(e)}newInput({id:e,name:t}){const i=new U({id:e,name:t,node:this,view:this.view,cssClassName:b.cssClassName});this.inputsMap.set(i.id,i),this.inputsDiv.appendChild(i.element)}newOutput({id:e,name:t}){const i=new q({id:e,name:t,node:this,view:this.view,cssClassName:b.cssClassName});this.outputsMap.set(i.id,i),this.outputsDiv.appendChild(i.element)}onDblclick(e){e.stopPropagation()}onPointerdown(e){if(e.isBubblingFromPin)return;e.isBubblingFromNode=!0,e.shiftKey||this.view.hasSelectedNodes&&this.isSelected||this.view.clearSelection(),this.view.selectNode(this)}toObject(){const{text:e,inputs:t,outputs:i,x:s,y:n}=this;return z(p(p(z(p({},super.toObject()),{text:e}),t.length>0?{ins:t.map(o=>o.toObject())}:{}),i.length>0?{outs:i.map(o=>o.toObject())}:{}),{x:s,y:n})}};let S=C;m(S,"cssClassName","fv-node"),m(S,"borderWidth",1),m(S,"minSize",b.size*4),m(S,"zIndex",L.zIndex+1),m(S,"style",{[`.${C.cssClassName}`]:p({position:"absolute","background-color":g.nodeBackgroundColor,"border-radius":g.borderRadius,"box-shadow":g.boxShadow,display:"flex","flex-direction":"column","justify-content":"space-between",border:`${C.borderWidth}px solid transparent`,"min-height":`${C.minSize}px`,"min-width":`${C.minSize}px`,width:"fit-content","z-index":C.zIndex},j("border-color")),[`.${N(C.cssClassName)}`]:{"border-color":g.borderColorHighlighted},[`.${W(C.cssClassName)}`]:{"border-color":g.errorColor},[`.${C.cssClassName} .content`]:{"user-select":"none","padding-left":"0.5em","padding-right":"0.5em","text-align":"center"},[`.${C.cssClassName} .pins`]:{display:"flex","flex-direction":"row",gap:`${b.size}px`,"justify-content":"space-between",height:`${b.size}px`}});export{S as FlowViewNode};const w=class extends ${init({nodeNames:e,position:t}){const{element:i}=this;i.setAttribute("tabindex",0),this.hint=this.createElement("input",`${w.cssClassName}__hint`);const s=this.input=this.createElement("input");this.options=this.createElement("div",[`${w.cssClassName}__options`]),this.nodeNames=e,this.position=t,this.highlightedOptionIndex=-1,this._onDblclick=this.onDblclick.bind(this),i.addEventListener("dblclick",this._onDblclick),this._onPointerdown=this.onPointerdown.bind(this),i.addEventListener("pointerdown",this._onPointerdown),this._onPointerleave=this.onPointerleave.bind(this),i.addEventListener("pointerleave",this._onPointerleave),this._onKeydown=this.onKeydown.bind(this),s.addEventListener("keydown",this._onKeydown),this._onKeyup=this.onKeyup.bind(this),s.addEventListener("keyup",this._onKeyup)}dispose(){const{element:e,input:t}=this;e.removeEventListener("dblclick",this._onDblclick),e.removeEventListener("pointerdown",this._onPointerdown),e.removeEventListener("pointerleave",this._onPointerdown),t.removeEventListener("keydown",this._onKeydown),t.removeEventListener("keyup",this._onKeyup)}focus(){this.input.focus()}get completion(){return this.hint.getAttribute("placeholder")}set completion(e){this.hint.setAttribute("placeholder",e)}get matchingNodes(){const e=this.input.value.toLowerCase();return e.length===0?[]:this.nodeNames.filter(t=>t.toLowerCase().startsWith(e)&&t.toLowerCase()!==e)}set position({x:e,y:t}){const{element:i,view:s}=this,n=t-s.origin.y+40>=s.height,a=e-s.origin.x+w.width>=s.width?s.width+s.origin.x-w.width-10:e,h=n?s.height+s.origin.y-50:t;i.style.top=`${h-s.origin.y}px`,i.style.left=`${a-s.origin.x}px`,this.x=a,this.y=h}get position(){return{x:this.x,y:this.y}}createNode(){var i,s,n,o;const e=(o=(n=(s=(i=this.options)==null?void 0:i.children)==null?void 0:s[this.highlightedOptionIndex])==null?void 0:n.textContent)!=null?o:this.input.value,t=this.nodeNames.find(([a])=>a.toLowerCase()===e.toLowerCase());this.view.newNode({x:this.position.x,y:this.position.y,text:t!=null?t:e}),this.view.removeSelector()}onDblclick(e){e.stopPropagation()}onKeyup(e){e.stopPropagation();const t=`${w.cssClassName}__option--highlighted`,i=()=>{for(let d=0;d<this.options.childElementCount;d++){const u=this.options.children[d];this.highlightedOptionIndex===d?u.classList.add(t):u.classList.remove(t)}},s=()=>{this.highlightedOptionIndex=Math.min(this.highlightedOptionIndex+1,this.options.childElementCount-1)},n=()=>{this.highlightedOptionIndex=this.highlightedOptionIndex!==-1?Math.max(this.highlightedOptionIndex-1,0):-1},o=()=>{for(;this.options.firstChild;)this.options.removeChild(this.options.lastChild)},a=()=>{this.highlightedOptionIndex=-1,o()},h=()=>{o();for(let d=0;d<this.matchingNodes.length;d++){const u=this.matchingNodes[d],x=document.createElement("div");x.classList.add(`${w.cssClassName}__option`),x.textContent=u,x.onclick=()=>{this.input.value=u,this.createNode()},x.onpointerenter=()=>{this.highlightedOptionIndex=d,x.classList.add(t)},x.onpointerleave=()=>{x.classList.remove(t)},this.options.append(x)}},l=()=>{switch(this.matchingNodes.length){case 0:this.completion="",this.highlightedOptionIndex=-1;break;case 1:{const d=this.matchingNodes[0];d.includes(this.input.value)&&(this.completion=d);break}default:if(this.highlightedOptionIndex===-1){this.completion=this.input.value;const d=this.matchingNodes.reduce((u,x)=>u.length<x.length?u:x);for(let u=this.input.value.length;u<d.length;u++){const x=d[u];this.matchingNodes.every(k=>k.startsWith(this.completion+x))&&(this.completion+=x)}}else this.completion=this.options.children[this.highlightedOptionIndex].textContent}},c=()=>{this.completion&&(this.input.value=this.completion)},f=()=>this.matchingNodes.find(d=>!d.startsWith(this.input.value)&&d.toLowerCase().startsWith(this.input.value.toLowerCase())),v=()=>{const d=f();!d||(this.input.value=d.substring(0,this.input.value.length),l())};switch(e.code){case"Enter":this.createNode();break;case"Escape":this.input.value===""?this.view.removeSelector():(this.completion="",this.input.value="",a());break;case"ArrowLeft":case"ShiftLeft":case"ShiftRight":break;case"ArrowDown":v(),s(),i(),l();break;case"ArrowUp":e.preventDefault(),v(),n(),i(),l();break;case"ArrowRight":this.input.value.length===e.target.selectionStart&&(c(),a());break;case"Backspace":this.highlightedOptionIndex=-1,h(),l();break;case"Tab":{if(e.preventDefault(),v(),this.matchingNodes.length===1){l(),c(),a();break}e.shiftKey?this.highlightedOptionIndex===0?this.highlightedOptionIndex=this.options.childElementCount-1:n():this.options.childElementCount-1===this.highlightedOptionIndex?this.highlightedOptionIndex=0:s(),h(),l(),i();break}default:h(),l()}}onKeydown(e){e.stopPropagation(),["ArrowUp","Tab"].includes(e.code)&&e.preventDefault()}onPointerdown(e){e.stopPropagation()}onPointerleave(){this.highlightedOptionIndex=-1}};let E=w;m(E,"cssClassName","fv-selector"),m(E,"zIndex",S.zIndex+1),m(E,"width",170),m(E,"padding",9),m(E,"style",{[`.${w.cssClassName}`]:{position:"absolute","box-shadow":g.boxShadow,"z-index":w.zIndex},[`.${w.cssClassName} input`]:{border:0,margin:0,outline:0,"border-radius":g.borderRadius,"font-family":g.fontFamily,"font-size":g.fontSize,padding:`${w.padding}px`,width:`${w.width-2*w.padding}px`},[`.${w.cssClassName}__hint`]:{position:"absolute",left:"0",background:"transparent","pointer-events":"none"},[`.${w.cssClassName}__hint::placeholder`]:{opacity:"0.4"},[`.${w.cssClassName}__options`]:{"background-color":g.nodeBackgroundColor,height:"fit-content"},[`.${w.cssClassName}__option`]:p({padding:"0.5em",border:"1px solid transparent",cursor:"default"},j("border-color")),[`.${w.cssClassName}__option--highlighted`]:{"border-color":g.borderColorHighlighted}});const O=class extends HTMLElement{static generateStylesheet(e){return Object.entries(e).reduce((t,[i,s])=>[t,`${i}{`,Object.entries(s).map(([n,o])=>`${n}:${o};`).join(""),"}"].join(""),"")}static pointerCoordinates(e){const{clientX:t,clientY:i,target:s}=e,{left:n,top:o}=s.getBoundingClientRect();return{x:Math.round(t-n),y:Math.round(i-o)}}constructor(){super();const e=document.createElement("template"),t=this.hasAttribute("light"),i=this.hasAttribute("dark"),s=t&&!i,n=!t&&i,{generateStylesheet:o}=O,a=o({":host":Y("light")}),h=o({":host":Y("dark")});e.innerHTML=["<style>",o(O.style),o({":host":{"color-scheme":s?"light":n?"dark":"light dark"}}),...s?a:n?h:[a,`@media(prefers-color-scheme:dark){${h}}`],"</style>"].join(""),this.attachShadow({mode:"open"}).appendChild(e.content.cloneNode(!0)),this._origin={x:0,y:0},this.nodesMap=new Map,this.edgesMap=new Map,this.itemClassMap=new Map,Object.entries(O.defaultItems).forEach(([l,c])=>{this.itemClassMap.set(l,c)}),this.selectorId=`selector-${$.generateId(this)}`}connectedCallback(){"ResizeObserver"in window?(this.rootResizeObserver=new ResizeObserver(this.onRootResize.bind(this)),this.rootResizeObserver.observe(this.parentNode)):this.height=this.getAttribute("height")||O.minHeight,this.getAttribute("tabindex")||this.setAttribute("tabindex",0),this.addEventListener("contextmenu",this.onContextmenu),this.addEventListener("dblclick",this.onDblclick),this.addEventListener("keydown",this.onKeydown),this.addEventListener("pointerdown",this.onPointerdown),this.addEventListener("pointermove",this.onPointermove),this.addEventListener("pointerleave",this.onPointerleave),this.addEventListener("pointerup",this.onPointerup)}disconnectedCallback(){this.removeResizeObserver(),this.removeEventListener("contextmenu",this.onContextmenu),this.removeEventListener("dblclick",this.onDblclick),this.removeEventListener("keydown",this.onKeydown),this.removeEventListener("pointerdown",this.onPointerdown),this.removeEventListener("pointermove",this.onPointermove),this.removeEventListener("pointerleave",this.onPointerleave),this.removeEventListener("pointerup",this.onPointerup)}removeResizeObserver(){var e;this.parentNode&&((e=this.rootResizeObserver)==null||e.unobserve(this.parentNode)),delete this.rootResizeObserver}get origin(){return this.translateVector&&!this.hasSelectedNodes?{x:this._origin.x+this.translateVector.x,y:this._origin.y+this.translateVector.y}:this._origin}get selectedEdges(){return this.edges.filter(e=>e.isSelected)}get hasSelectedNodes(){return this.selectedNodes.length>0}get isDraggingEdge(){return this.semiEdge instanceof L}get selectedNodeIds(){return this.selectedNodes.map(e=>e.id)}get selectedNodes(){return this.nodes.filter(e=>e.isSelected)}get edges(){return[...this.edgesMap.values()]}get nodes(){return[...this.nodesMap.values()]}get height(){return parseInt(this.style.height)}set height(e){this.style.height=`${e}px`}get width(){return parseInt(this.style.width)}set width(e){this.style.width=`${e}px`}clear(e){this.nodes.forEach(t=>{this.deleteNode(t.id,e)})}newEdge({id:e,source:t,target:i},s){const n=this.itemClassMap.get("edge"),o=new n({id:e,view:this,cssClassName:n.cssClassName,source:t,target:i});return this.edgesMap.set(o.id,o),this.host.viewChange({createdEdge:o.toObject()},s),o}newNode({x:e=0,y:t=0,text:i,id:s,type:n,ins:o=[],outs:a=[]},h){var k,D,R,A,B,K,J;const l=(D=(k=this.host.textToType(i))!=null?k:this.host.nodeNameTypeMap.get(i))!=null?D:n,c=this.host.nodeTypeDefinitionMap.get(l),f=(A=(R=c==null?void 0:c.inputs)==null?void 0:R.map((G,X)=>{var _;return p(p({},G),(_=o[X])!=null?_:{})}))!=null?A:o,v=(K=(B=c==null?void 0:c.outputs)==null?void 0:B.map((G,X)=>{var _;return p(p({},G),(_=a[X])!=null?_:{})}))!=null?K:a,d=(J=this.itemClassMap.get(l))!=null?J:this.itemClassMap.get("node"),u=new d({id:s,view:this,cssClassName:d.cssClassName,text:i,inputs:f,outputs:v,x:e,y:t,type:l});this.nodesMap.set(u.id,u);const x=l?z(p({},u.toObject()),{type:l}):u.toObject();return this.host.viewChange({createdNode:x},h),u}selectEdge(e){e.highlight=!0,e.selected=!0,e.source.highlight=!0,e.target.highlight=!0}selectNode(e){e.highlight=!0,e.selected=!0;for(const t of this.edges)t.source.node.isSelected&&t.target.node.isSelected?this.selectEdge(t):this.deselectEdge(t)}deselectEdge(e){e.highlight=!1,e.selected=!1,e.source.node.isSelected||(e.source.highlight=!1),e.target.node.isSelected||(e.target.highlight=!1)}deselectNode(e){e.highlight=!1,e.selected=!1;for(const t of e.inputs)t.highlight=!1;for(const t of e.outputs)t.highlight=!1}deleteEdge(e,t){const i=this.edgesMap.get(e);if(!i)return;i.source.highlight=!1,i.target.highlight=!1,this.edgesMap.delete(i.id),i.remove();const s=i.toObject();return this.host.viewChange({deletedEdge:s},t),s}deleteNode(e,t){const i=this.nodesMap.get(e);if(!i)return;for(const n of this.edges)(n.source.node.id===i.id||n.target.node.id===i.id)&&this.deleteEdge(n.id,t);this.nodesMap.delete(i.id),i.remove();const s=i.toObject();return this.host.viewChange({deletedNode:s},t),s}edge(e){if(!this.edgesMap.has(e))throw new T({kind:"edge",id:e});return this.edgesMap.get(e)}node(e){if(!this.nodesMap.has(e))throw new T({kind:"node",id:e});return this.nodesMap.get(e)}enableBodyScroll(){document.body.style.overflow=this._bodyOverflow}disableBodyScroll(){this._bodyOverflow=document.body.style.overflow,document.body.style.overflow="hidden"}startTranslation(e){if(this.disableBodyScroll(),this.startDraggingPoint=O.pointerCoordinates(e),this.translateVector={x:0,y:0},this.hasSelectedNodes){const t={};for(const i of this.selectedNodes)t[i.id]=i.position;this.selectedNodesStartPosition=t}}stopTranslation(){this.translateVector&&!this.hasSelectedNodes&&!this.semiEdge&&(this._origin={x:this._origin.x+this.translateVector.x,y:this._origin.y+this.translateVector.y}),delete this.translateVector,delete this.startDraggingPoint,delete this.selectedNodesStartPosition,this.enableBodyScroll()}createSelector({position:e}){return this.selector=new E({id:this.selectorId,view:this,cssClassName:E.cssClassName,position:e,nodeNames:[...this.host.nodeNameTypeMap.keys()]})}updateNode({node:e}){this.host.viewChange({updatedNode:e.toObject()},viewChangeInfo)}onContextmenu(e){e.preventDefault()}onDblclick(e){this.clearSelection(),this.removeSelector();const t=O.pointerCoordinates(e);this.createSelector({position:{x:t.x+this.origin.x,y:t.y+this.origin.y}}).focus()}onKeydown(e){switch(e.stopPropagation(),!0){case this.selector instanceof E:return;case e.code==="Backspace":this.deleteSelectedItems();break;case e.code==="Escape":this.clearSelection();break;default:break}}onPointerdown(e){e.stopPropagation(),this.removeSelector(),e.isBubblingFromNode||this.clearSelection(),e.shiftKey||this.startTranslation(e)}onPointermove(e){const{hasSelectedNodes:t,semiEdge:i,startDraggingPoint:s}=this;if(s){const n=O.pointerCoordinates(e),o=s.x-n.x,a=s.y-n.y;switch(!0){case!!i:{i.hasTarget||(i.target.center.x=n.x+this.origin.x,i.target.center.y=n.y+this.origin.y),i.updateGeometry();break}case t:{this.translateVector={x:o,y:a};const{edges:h,selectedNodes:l,selectedNodeIds:c,selectedNodesStartPosition:f}=this;for(const v of l){const{x:d,y:u}=f[v.id];v.position={x:d-o,y:u-a}}for(const v of h)(c.includes(v.source.node.id)||c.includes(v.target.node.id))&&v.updateGeometry();break}default:{this.translateVector={x:o,y:a};const{nodes:h,edges:l}=this;for(const c of h){const{x:f,y:v}=c.position;c.position={x:f,y:v}}for(const c of l)c.updateGeometry()}}}}onPointerleave(){this.stopTranslation(),this.removeSemiEdge()}onPointerup(){this.stopTranslation(),this.removeSemiEdge()}onRootResize(e){for(const t of e)if(this.parentNode===t.target){const i=Array.isArray(t.contentBoxSize)?t.contentBoxSize[0]:t.contentBoxSize;i?(this.width=i.inlineSize,this.height=i.blockSize):t.contentRect&&(this.width=t.contentRect.width,this.height=t.contentRect.height)}}createSemiEdge({source:e,target:t},i){const s=this.itemClassMap.get("edge");this.semiEdge=new s({view:this,cssClassName:s.cssClassName,source:e,target:t}),this.host.viewChange({createdSemiEdge:{from:e instanceof b?[e.node.id,e.id]:void 0,to:t instanceof b?[t.node.id,t.id]:void 0}},i)}clearSelection(){for(const e of this.selectedNodes)this.deselectNode(e);for(const e of this.selectedEdges)this.deselectEdge(e)}deleteSelectedItems(){for(const e of this.selectedEdges)this.deleteEdge(e.id);for(const e of this.selectedNodes)this.deleteNode(e.id)}removeSemiEdge(e){if(!this.semiEdge)return;const{source:t,target:i}=this.semiEdge;this.semiEdge.remove(),delete this.semiEdge,this.host.viewChange({deletedSemiEdge:{from:t instanceof b?[t.node.id,t.id]:void 0,to:i instanceof b?[i.node.id,i.id]:void 0}},e)}removeSelector(){this.selector instanceof E&&this.selector.remove(),this.selector=void 0}};let y=O;m(y,"customElementName","flow-view"),m(y,"minHeight",200),m(y,"defaultItems",{edge:L,node:S}),m(y,"style",p(p(p(p({":host([hidden])":{display:"none"},":host":{position:"relative",display:"block",overflow:"hidden",border:0,margin:0,outline:0,"background-color":g.backgroundColor,"border-radius":g.borderRadius,"box-shadow":g.boxShadow,"font-family":g.fontFamily,"font-size":g.fontSize,color:g.textColor}},L.style),S.style),b.style),E.style));export{y as FlowViewElement};class ae{constructor(e){if(window.customElements.get(y.customElementName)||window.customElements.define(y.customElementName,y),e instanceof y)e.host=this,this.view=e;else if(e instanceof HTMLElement){const t=this.view=document.createElement(y.customElementName);t.host=this,e.appendChild(t)}else throw new ee;this.view.style.isolation="isolate",this.nodeNameTypeMap=new Map,this.nodeTypeDefinitionMap=new Map,this.onViewChange=()=>{},this.textToType=()=>{}}get graph(){const{view:{nodes:e,edges:t}}=this;return{nodes:e.map(i=>i.toObject()),edges:t.map(i=>i.toObject())}}destroy(){this.view.parentNode.removeChild(this.view)}node(e){return this.view.node(e)}edge(e){return this.view.edge(e)}addNodeDefinitions({nodes:e=[],types:t={}}){e.forEach(({name:i,type:s})=>this.nodeNameTypeMap.set(i,s)),Object.entries(t).forEach(([i,{inputs:s,outputs:n}])=>this.nodeTypeDefinitionMap.set(i,{inputs:s,outputs:n}))}clearGraph(){this.view.clear({isClearGraph:!0})}loadGraph({nodes:e=[],edges:t=[]}){for(const i of e)this.newNode(i,{isLoadGraph:!0});for(const i of t)this.newEdge(i,{isLoadGraph:!0})}onChange(e){this.onViewChange=e}viewChange({createdNode:e,createdEdge:t,createdSemiEdge:i,deletedNode:s,deletedEdge:n,deletedSemiEdge:o,updatedNode:a},h={}){e&&this.onViewChange({action:"CREATE_NODE",data:e},h),t&&this.onViewChange({action:"CREATE_EDGE",data:t},h),i&&this.onViewChange({action:"CREATE_SEMI_EDGE",data:i},h),s&&this.onViewChange({action:"DELETE_NODE",data:s},h),n&&this.onViewChange({action:"DELETE_EDGE",data:n},h),o&&this.onViewChange({action:"DELETE_SEMI_EDGE",data:o},h),a&&this.onViewChange({action:"UPDATE_NODE",data:a},h)}newEdge({id:e,from:[t,i],to:[s,n]},o={isProgrammatic:!0}){const a=this.view.node(t),h=this.view.node(s),l=a.output(i),c=h.input(n);return this.view.newEdge({id:e,source:l,target:c},o)}newNode(e,t={isProgrammatic:!0}){return this.view.newNode(e,t)}deleteNode(e,t={isProgrammatic:!0}){return this.view.deleteNode(e,t)}deleteEdge(e,t={isProgrammatic:!0}){return this.view.deleteEdge(e,t)}addNodeClass(e,t){if(this.view.itemClassMap.set(e,t),t.style)try{const i=document.createElement("style");i.textContent=y.generateStylesheet(t.style),this.view.shadowRoot.appendChild(i)}catch(i){throw console.error(i),new te}}nodeTextToType(e){this.textToType=e}}export{ae as FlowView};
